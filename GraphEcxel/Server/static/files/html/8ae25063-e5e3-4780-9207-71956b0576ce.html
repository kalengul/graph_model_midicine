<!DOCTYPE html>
<html>
    <head>
        <title>f1b491dd-d0c9-476b-a410-9d2aa895eb5d</title>
        <meta charset="utf-8">
        <link rel="stylesheet" href="./css/index.css">
        <style>
            .Graphcontainer{
                width: 98%;
                height: 85vh;

                border: solid 0.5px black;
                border-radius: 7px;
            }

            .svgGraph{
                width: 100%;
                height: 100%;
            }   
        </style>
        <script src="./d3.v7.js"></script>
    </head>
    <body>
        <main>
            <div class="flex jc-center">
                <h1>f1b491dd-d0c9-476b-a410-9d2aa895eb5d</h1>
            </div>
            <br/>
            <div class='Graphcontainer' >
                <svg class='svgGraph'> </svg>
            </div>
        </main>

        <script>
            const colors = {
                selectNode: "#E8BD6D",
                selectLink: "#8B7474",
                node: "#E9EEF4",
                link: '#B8B5B5'
            }

            const nodeView = {
                r: 30
            }

            const graphData = {"directed":true,"multigraph":false,"graph":{},"nodes":[{"name":"средство для лечение сахарный диабет","label":"group","weight":5,"id":"d55f0c73-c138-4be8-a226-d2bd76c208ae","level":0,"r":30,"y":137.5,"x":1200},{"name":"гипогликемический средство","label":"group","weight":5,"id":"dd5048aa-929a-47d4-b501-d7320ff1e8c5","level":1,"r":30,"y":267.5,"x":1200},{"name":"инсулин","label":"prepare","weight":5,"id":"d9d0178a-1f45-4f04-b35e-ff3d2737d2db","level":5,"r":30,"y":787.5,"x":400},{"name":"бигуанид","label":"group","weight":5,"id":"c7c63270-f4d4-4b80-bda1-3427582ae872","level":2,"r":30,"y":397.5,"x":1200},{"name":"метформин","label":"prepare","weight":5,"id":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","level":3,"r":30,"y":527.5,"x":1200},{"name":"гипогликемический действие","label":"mechanism","weight":5,"id":"578f3c2e-7cd1-4455-a8d8-46cd7fb1297a","level":6,"r":30,"y":917.5,"x":1200},{"name":"недостаточность витамин в 12","label":"side_e","weight":5,"id":"82524aa0-ebbf-46cf-a0c5-3cfefa3af291","level":4,"r":30,"y":657.5,"x":48},{"name":"мегалобластной анемия","label":"side_e","weight":5,"id":"e9f657b8-26e1-4219-b4ee-f15075d5e06e","level":4,"r":30,"y":657.5,"x":128},{"name":"лактоацидоз","label":"side_e","weight":5,"id":"9fc32361-a6aa-4224-b67d-52bfa02da832","level":4,"r":30,"y":657.5,"x":208},{"name":"металлический привкус в рот","label":"side_e","weight":5,"id":"3f4b935d-75cb-49cd-97ed-46045f4caec6","level":4,"r":30,"y":657.5,"x":288},{"name":"тошнота","label":"side_e","weight":5,"id":"db3e415e-f948-4945-884f-03f24657f969","level":4,"r":30,"y":657.5,"x":368},{"name":"рвота","label":"side_e","weight":5,"id":"a12c8da5-43b7-4e40-8d2b-abd30f9c02b1","level":4,"r":30,"y":657.5,"x":448},{"name":"диарея","label":"side_e","weight":5,"id":"ed00fe53-081b-41f0-9cf4-729b6ddb3f52","level":4,"r":30,"y":657.5,"x":528},{"name":"боль в живот","label":"side_e","weight":5,"id":"153c8299-7249-4964-a27c-8c12e1316c70","level":4,"r":30,"y":657.5,"x":608},{"name":"отсутствие аппетит","label":"side_e","weight":5,"id":"f3cd1ae2-fcc1-4e38-851d-33da3fbfe85a","level":4,"r":30,"y":657.5,"x":688},{"name":"гепатит","label":"side_e","weight":5,"id":"cabc88d5-e3ff-4b98-99c1-71646c526000","level":4,"r":30,"y":657.5,"x":768},{"name":"кожный реакция","label":"side_e","weight":5,"id":"8ead384e-9f8c-4ce8-b438-506189be0dba","level":4,"r":30,"y":657.5,"x":848},{"name":"эритема (покраснение кожа)","label":"side_e","weight":5,"id":"41caa3f6-93fc-4969-b7aa-c77df83a87e3","level":4,"r":30,"y":657.5,"x":928},{"name":"зуд","label":"side_e","weight":5,"id":"cbc0c0b9-b150-42c8-9cb5-42be8209e1ce","level":4,"r":30,"y":657.5,"x":1008},{"name":"крапивница","label":"side_e","weight":5,"id":"dbca51c2-a722-4a0f-bebf-9a9877e3e609","level":4,"r":30,"y":657.5,"x":1088},{"name":"снижать выработка глюкоза печень","label":"mechanism","weight":5,"id":"b9035853-f43e-4910-af81-fc36da05f9b9","level":5,"r":30,"y":787.5,"x":480},{"name":"задерживать всасывание глюкоза в кишечник","label":"mechanism","weight":5,"id":"6092fbfd-5e82-48ef-92fc-12258e3a084e","level":4,"r":30,"y":657.5,"x":1168},{"name":"стимулировать синтез внутриклеточный гликоген","label":"mechanism","weight":5,"id":"178ea0be-19e1-458c-bc9a-5cadc380c3b9","level":5,"r":30,"y":787.5,"x":560},{"name":"воздействовать на гликогенсинтаз","label":"mechanism","weight":5,"id":"03710785-c264-4ac9-88d0-b0f2e9026f94","level":4,"r":30,"y":657.5,"x":1248},{"name":"увеличивать транспортный ёмкость весь тип мембранный переносчик глюкоза","label":"mechanism","weight":5,"id":"dd4ff00f-667b-420f-9728-77abf19f244c","level":4,"r":30,"y":657.5,"x":1328},{"name":"почка","label":"excretion","weight":5,"id":"f53e6f17-b1a5-48b8-9ede-654ec808b344","level":4,"r":30,"y":657.5,"x":1408},{"name":"повышать чувствительность периферический рецептор","label":"mechanism","weight":5,"id":"050096b5-bce8-4113-9104-b139ff284119","level":4,"r":30,"y":657.5,"x":1488},{"name":"повышать утилизация глюкоза клетка","label":"mechanism","weight":5,"id":"00435638-fece-4999-9a0a-e29cb8f1a805","level":4,"r":30,"y":657.5,"x":1568},{"name":"ингибирование глюконеогенез","label":"mechanism","weight":5,"id":"0919b134-fdea-4f2a-9eb7-dcc484fd5c32","level":4,"r":30,"y":657.5,"x":1648},{"name":"ингибирование гликогенолиз","label":"mechanism","weight":5,"id":"ba92e309-2621-48e1-9784-b78082c27afd","level":4,"r":30,"y":657.5,"x":1728},{"name":"снижать концентрация общий холестерин","label":"mechanism","weight":5,"id":"91ef853b-c6b1-41fd-8e16-afe2439f10e8","level":4,"r":30,"y":657.5,"x":1808},{"name":"снижать концентрация липопротеин низкий плотность","label":"mechanism","weight":5,"id":"8775a33c-b811-4fb6-a592-39293e2ff1a4","level":4,"r":30,"y":657.5,"x":1888},{"name":"снижать концентрация триглицерид","label":"mechanism","weight":5,"id":"f894d972-ea4c-4a6f-b89c-63849a0095e0","level":4,"r":30,"y":657.5,"x":1968},{"name":"снижать базальный концентрация глюкоза в плазма кровь","label":"action","weight":5,"id":"67edb336-8b6a-4957-b95c-52af180a56fa","level":7,"r":30,"y":1047.5,"x":600},{"name":"снижать постпрандиальный концентрация глюкоза в плазма кровь","label":"action","weight":5,"id":"7944b7b1-b1a2-44bd-a580-60ec0e2c4280","level":7,"r":30,"y":1047.5,"x":680}],"links":[{"source":"d55f0c73-c138-4be8-a226-d2bd76c208ae","target":"dd5048aa-929a-47d4-b501-d7320ff1e8c5"},{"source":"dd5048aa-929a-47d4-b501-d7320ff1e8c5","target":"c7c63270-f4d4-4b80-bda1-3427582ae872"},{"source":"d9d0178a-1f45-4f04-b35e-ff3d2737d2db","target":"578f3c2e-7cd1-4455-a8d8-46cd7fb1297a"},{"source":"c7c63270-f4d4-4b80-bda1-3427582ae872","target":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"82524aa0-ebbf-46cf-a0c5-3cfefa3af291"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"e9f657b8-26e1-4219-b4ee-f15075d5e06e"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"9fc32361-a6aa-4224-b67d-52bfa02da832"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"3f4b935d-75cb-49cd-97ed-46045f4caec6"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"db3e415e-f948-4945-884f-03f24657f969"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"a12c8da5-43b7-4e40-8d2b-abd30f9c02b1"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"ed00fe53-081b-41f0-9cf4-729b6ddb3f52"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"153c8299-7249-4964-a27c-8c12e1316c70"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"f3cd1ae2-fcc1-4e38-851d-33da3fbfe85a"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"cabc88d5-e3ff-4b98-99c1-71646c526000"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"8ead384e-9f8c-4ce8-b438-506189be0dba"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"41caa3f6-93fc-4969-b7aa-c77df83a87e3"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"cbc0c0b9-b150-42c8-9cb5-42be8209e1ce"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"dbca51c2-a722-4a0f-bebf-9a9877e3e609"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"6092fbfd-5e82-48ef-92fc-12258e3a084e"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"03710785-c264-4ac9-88d0-b0f2e9026f94"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"dd4ff00f-667b-420f-9728-77abf19f244c"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"f53e6f17-b1a5-48b8-9ede-654ec808b344"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"050096b5-bce8-4113-9104-b139ff284119"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"00435638-fece-4999-9a0a-e29cb8f1a805"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"0919b134-fdea-4f2a-9eb7-dcc484fd5c32"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"ba92e309-2621-48e1-9784-b78082c27afd"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"91ef853b-c6b1-41fd-8e16-afe2439f10e8"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"8775a33c-b811-4fb6-a592-39293e2ff1a4"},{"source":"f1b491dd-d0c9-476b-a410-9d2aa895eb5d","target":"f894d972-ea4c-4a6f-b89c-63849a0095e0"},{"source":"578f3c2e-7cd1-4455-a8d8-46cd7fb1297a","target":"67edb336-8b6a-4957-b95c-52af180a56fa"},{"source":"578f3c2e-7cd1-4455-a8d8-46cd7fb1297a","target":"7944b7b1-b1a2-44bd-a580-60ec0e2c4280"},{"source":"b9035853-f43e-4910-af81-fc36da05f9b9","target":"578f3c2e-7cd1-4455-a8d8-46cd7fb1297a"},{"source":"6092fbfd-5e82-48ef-92fc-12258e3a084e","target":"578f3c2e-7cd1-4455-a8d8-46cd7fb1297a"},{"source":"178ea0be-19e1-458c-bc9a-5cadc380c3b9","target":"578f3c2e-7cd1-4455-a8d8-46cd7fb1297a"},{"source":"03710785-c264-4ac9-88d0-b0f2e9026f94","target":"178ea0be-19e1-458c-bc9a-5cadc380c3b9"},{"source":"dd4ff00f-667b-420f-9728-77abf19f244c","target":"578f3c2e-7cd1-4455-a8d8-46cd7fb1297a"},{"source":"050096b5-bce8-4113-9104-b139ff284119","target":"d9d0178a-1f45-4f04-b35e-ff3d2737d2db"},{"source":"00435638-fece-4999-9a0a-e29cb8f1a805","target":"578f3c2e-7cd1-4455-a8d8-46cd7fb1297a"},{"source":"0919b134-fdea-4f2a-9eb7-dcc484fd5c32","target":"b9035853-f43e-4910-af81-fc36da05f9b9"},{"source":"ba92e309-2621-48e1-9784-b78082c27afd","target":"b9035853-f43e-4910-af81-fc36da05f9b9"}],"name":["f1b491dd-d0c9-476b-a410-9d2aa895eb5d"],"maxLevel":8,"levelsInfo":{"levelNodesCount":{"0":1,"1":1,"2":1,"3":1,"4":25,"5":3,"6":1,"7":2}},"isParse":true}
            const window_params = {"width":1200,"height":600,"xStep":50,"yStep":100}

            console.log(graphData)

            

            if (graphData){
                const svg = d3.select("svg")
                svg.selectAll("*").remove() // Очистка предыдущего графа

                svg.attr("width",   window_params.width) //Устанавливает атрибут width
                .attr("height",   window_params.height)
                .append("g").attr('class', 'group') //добавляет новый элемент, тег которого передается в метод в качестве параметра

                const svgGroup = svg.select('g.group')

                // Масштабирование и перемещение
                const zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on("zoom", (event)=>{ //Обновление позиционирования элементов при масштабировании
                    svgGroup.attr("transform", event.transform);
                });
                svg.call(zoom);


                const dragstarted = (event, d)=>{
                    if (!event.active) simulation.alphaTarget(0.3).restart(); // Увеличиваем "температуру" симуляции для более плавного движения
                    d.fx = d.x; // Фиксируем позицию узла
                    d.fy = d.y;
                }
                
                const dragged = (event, d)=>{
                    d.fx = event.x; // Обновляем фиксированные координаты узла
                    d.fy = event.y;
                }
                
                const dragended = (event, d)=>{
                    if (!event.active) simulation.alphaTarget(0); // Охлаждаем симуляцию после перетаскивания
                    d.fx = null; // Отпускаем узел, позволяя симуляции снова влиять на его позицию
                    d.fy = null;
                }

                // Создаем обработчик drag
                const drag = d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);


                // Определение маркера стрелки
                svgGroup.append("defs")
                .append("marker")
                .attr("id", "arrowhead")
                .attr("markerWidth", 5) //Размер области, в которой будет отображаться маркер
                .attr("markerHeight", 4)
                .attr("refX", nodeView.r+4)
                .attr("refY", 2)
                .attr("orient", "auto")
                .append("polygon")
                .attr("points", "0 0, 5 2, 0 4")
                .style("fill", colors.link);

                
                //Добавление ссылок
                let links = svgGroup.append("g").attr('class', 'links')
                .selectAll('.link')
                .data(graphData.links) //Добавление данных
                .enter() //Нужен для ввода дополнительных значений (так как data привязывает только первое)
                .append('path')
                .attr('class', 'link')
                .attr('stroke', d=>{
                    //if((d.source.id === selectedNodes.sourseNode && d.target.id === selectedNodes.targetNode)||(d.target.id === selectedNodes.sourseNode && d.source.id === selectedNodes.targetNode)) return colors.selectLink
                    return colors.link
                }) // Цвет линии ребра
                .attr('stroke-width', d=>{
                    //if((d.source.id === selectedNodes.sourseNode && d.target.id === selectedNodes.targetNode)||(d.target.id === selectedNodes.sourseNode && d.source.id === selectedNodes.targetNode)) return 2
                    return 1
                }) // Ширина линии ребра
                .attr("marker-end", "url(#arrowhead)") // Добавление стрелки в конец ребра
                .style('pointer-events', 'none') //(устанавливает стиль) Отключение событий на ребрах (клики и т.д.)

                // Создание узлов
                let nodes = svgGroup.append("g").attr('class', 'nodes')
                .selectAll('.node')
                .data(graphData.nodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .call(drag);

                nodes.append('circle')
                .attr('class', 'node')
                .attr('id', d => d.id)
                .attr('r', d => d.r) // Радиус узла
                .attr('fill', d=>{
                    //if(selectedNodes.sourseNode === d.id || selectedNodes.targetNode === d.id) return colors.selectNode
                    return colors.node
                }) // Цвет заполнения
                .attr("cursor", "pointer")
                .on('click', (event, d) => {
                    // Добавьте логику для обработки клика по узлу
                });

                //Отображение текста v2
                nodes.append('foreignObject')
                .attr('x', d => -d.r * 0.8)
                .attr('y', d => -d.r * 0.8)
                .attr('width', d => d.r * 1.6)
                .attr('height', d => d.r * 1.6)
                .append('xhtml:div')
                .style('display', 'flex')
                .style('justify-content', 'center')
                .style('align-items', 'center')
                .style('width', '100%')
                .style('height', '100%')
                .style('font-size', '5px')
                .style('text-anchor', 'middle')
                .style('word-wrap', 'break-word')
                .style('overflow', 'hidden')
                .style('pointer-events', 'none')
                .text(d => d.name);

                //Создание симуляции силы v3
                const simulation = d3.forceSimulation(graphData.nodes)
                // Связи между узлами
                .force("link", d3.forceLink(graphData.links).id(d => d.id))//.distance(nodeView.r*10)) //!!! Сила в зависимости от количества узлов в уровне!!!!!
                // Отталкивание узлов
                .force("charge", d3.forceManyBody(graphData.nodes).strength(d=>graphData.levelsInfo.levelNodesCount[d.level]*(-100)))//-3000))
                // Центрирование по x
                .force("center", d3.forceCenter( window_params.width / 2,  window_params.height / 2))
                // Выравнивание по уровням
                .force("y", d3.forceY().strength(6)
                    .y(d =>  window_params.height * ((d.level+1) / (graphData.maxLevel-1)))) //!!!!!!!!!!Уровень с большим числом узлов шире, чем с меньшим
                // Отталкивание по x в рамках одного уровня
                .force("x", d3.forceX().strength(0.05)
                    .x( window_params.width / 2))
                // Дополнительная сила для предотвращения наложения узлов
                .force("collision", d3.forceCollide().radius(40));

                // Обновление позиций узлов и связей при каждой итерации симуляции
                //Обновление симуляции
                simulation.on('tick', () => {
                    links.attr("d", d => `M${d.source.x},${d.source.y} L${d.target.x},${d.target.y}`);
                    nodes.attr('transform', d => `translate(${d.x}, ${d.y})`); // Правильная позиция для групп
                });
            }
        </script>
    </body>
</html>