<!DOCTYPE html>
<html>
    <head>
        <title>ацетилсалициловая кислота</title>
        <meta charset="utf-8">
        <link rel="stylesheet" href="./css/index.css">
        <style>
            .Graphcontainer{
                width: 98%;
                height: 85vh;

                border: solid 0.5px black;
                border-radius: 7px;
            }

            .svgGraph{
                width: 100%;
                height: 100%;
            }   
        </style>
        <script src="./d3.v7.js"></script>
    </head>
    <body>
        <main>
            <div class="flex jc-center">
                <h1>ацетилсалициловая кислота</h1>
            </div>
            <br/>
            <div class='Graphcontainer' >
                <svg class='svgGraph'> </svg>
            </div>
        </main>

        <script>
            const colors = {
                selectNode: "#E8BD6D",
                selectLink: "#8B7474",
                node: "#E9EEF4",
                link: '#B8B5B5'
            }

            const nodeView = {
                r: 30
            }

            const graphData = {"directed":true,"multigraph":false,"graph":{},"nodes":[{"label":"prepare","weight":5,"id":"ae34c09d-b8c2-4987-901d-c9d87b8e9bc4","name":"ацетилсалициловый кислота","level":2,"r":30,"y":397.5,"x":1200},{"label":"group","weight":5,"id":"a7fb697d-4662-4bb6-a056-6976cbcda7a8","name":"антитромботический средство","level":0,"r":30,"y":137.5,"x":1200},{"label":"group","weight":5,"id":"1f1bccc8-2dcc-445f-94ef-2d1121ea7df1","name":"антиагрегант, кроме гепарин","level":1,"r":30,"y":267.5,"x":1200},{"label":"mechanism","weight":5,"id":"f406e632-e8c7-40b8-9c94-f554294a8b59","name":"блокировать синтез тромбоксан А2","level":4,"r":30,"y":657.5,"x":171.42857142857142},{"label":"mechanism","weight":5,"id":"a4f81891-9fcb-47db-a563-760bc8b9b2f1","name":"подавлять агрегация тромбоцит","level":5,"r":30,"y":787.5,"x":1200},{"label":"side_e","weight":5,"id":"8e3e27d3-fd79-4b29-86e5-a2e14412c32a","name":"язвы","level":4,"r":30,"y":657.5,"x":251.42857142857142},{"label":"side_e","weight":5,"id":"a00558bb-1ee9-4c2e-a374-72ba76dd3d41","name":"эрозия слизистый оболочка желудок и двенадцатиперстной кишка","level":4,"r":30,"y":657.5,"x":331.42857142857144},{"label":"side_e","weight":5,"id":"3753afcd-4ca5-4bb4-8cc8-1c48c68345a3","name":"перфоративные язвы слизистой оболочки желудка и двенадцатиперстной кишки","level":4,"r":30,"y":657.5,"x":411.42857142857144},{"label":"side_e","weight":5,"id":"17f61e91-0d4f-4d4c-aa90-7617c18574c9","name":"внутричерепной кровотечение","level":6,"r":30,"y":917.5,"x":133.33333333333334},{"label":"side_e","weight":5,"id":"4ef57d4e-5b18-45bf-a259-e87c83bf6d51","name":"геморрагический инсульт","level":7,"r":30,"y":1047.5,"x":1200},{"label":"side_e","weight":5,"id":"2710d4e4-d85a-49ab-8cc2-b5cf9fca276c","name":"кровотечение из желудочно-кишечный тракт","level":6,"r":30,"y":917.5,"x":213.33333333333334},{"label":"side_e","weight":5,"id":"8673bcf9-0a5b-42e2-b1be-e6b54cc2a6cc","name":"кровоточивость десен","level":6,"r":30,"y":917.5,"x":293.33333333333337},{"label":"side_e","weight":5,"id":"81d1678a-8322-4ced-98c5-8cd6994bdfd3","name":"носовой кровотечение","level":6,"r":30,"y":917.5,"x":373.33333333333337},{"label":"side_e","weight":5,"id":"267ad040-4333-4995-826a-447fea93af45","name":"мышечный кровоизлияние","level":6,"r":30,"y":917.5,"x":453.33333333333337},{"label":"side_e","weight":5,"id":"3b959890-dd2e-42dc-bae3-5e442fb7b6cb","name":"гематома","level":6,"r":30,"y":917.5,"x":533.3333333333334},{"label":"side_e","weight":5,"id":"4d49048f-9d71-49b4-adf9-42a515d48474","name":"геморрагия","level":6,"r":30,"y":917.5,"x":613.3333333333334},{"label":"side_e","weight":5,"id":"c62ec58d-642c-4bdb-9e57-60db266ebbc3","name":"кровотечение во время медицинский процедура","level":6,"r":30,"y":917.5,"x":693.3333333333334},{"label":"side_e","weight":5,"id":"2e2ec5b7-0101-4f41-9195-99f6909293b2","name":"кровотечение из мочеполовой путь","level":6,"r":30,"y":917.5,"x":773.3333333333334},{"label":"excretion","weight":5,"id":"75095284-4f43-4b14-842a-f94bac913c9b","name":"почка","level":3,"r":30,"y":527.5,"x":300},{"label":"absorbtion","weight":5,"id":"0423f15a-bdee-4aa8-a5fb-88bff652c6c2","name":"желудочный-кишечный тракт","level":3,"r":30,"y":527.5,"x":380},{"label":"link_prot","weight":5,"id":"61ef2516-24e5-4abd-a58a-913060fe7eb3","name":"белок плазма кровь","level":3,"r":30,"y":527.5,"x":460},{"label":"action","weight":5,"id":"bcf99a52-d1e3-4a84-9fba-1b2d065930dd","name":"действие противовоспалительный","level":4,"r":30,"y":657.5,"x":491.42857142857144},{"label":"action","weight":5,"id":"d1576439-a5e7-468c-8a96-4406a09cabd3","name":"действие анальгезировать","level":4,"r":30,"y":657.5,"x":571.4285714285714},{"label":"action","weight":5,"id":"8a93aed9-2f32-4c10-85a6-24479e38583c","name":"действие жаропонировать","level":4,"r":30,"y":657.5,"x":651.4285714285714},{"label":"mechanism","weight":5,"id":"f4dad33b-227e-4565-8410-4bc12edf36b8","name":"ингибирование цог-1","level":3,"r":30,"y":527.5,"x":540}],"links":[{"source":"ae34c09d-b8c2-4987-901d-c9d87b8e9bc4","target":"75095284-4f43-4b14-842a-f94bac913c9b","id":"35cbca54-f76c-47a7-8f37-6c9a21bf3995"},{"source":"ae34c09d-b8c2-4987-901d-c9d87b8e9bc4","target":"0423f15a-bdee-4aa8-a5fb-88bff652c6c2","id":"f1a25512-86ac-4431-af19-167fab5e7bc8"},{"source":"ae34c09d-b8c2-4987-901d-c9d87b8e9bc4","target":"61ef2516-24e5-4abd-a58a-913060fe7eb3","id":"de09ddd2-60d2-4096-9a21-767541ecdcd3"},{"source":"ae34c09d-b8c2-4987-901d-c9d87b8e9bc4","target":"f4dad33b-227e-4565-8410-4bc12edf36b8","id":"1e25bf6a-54e6-4f03-a865-8bd51fac2849"},{"source":"a7fb697d-4662-4bb6-a056-6976cbcda7a8","target":"1f1bccc8-2dcc-445f-94ef-2d1121ea7df1","id":"84832347-230e-4978-ac9b-a0b0b2ebf072"},{"source":"1f1bccc8-2dcc-445f-94ef-2d1121ea7df1","target":"ae34c09d-b8c2-4987-901d-c9d87b8e9bc4","id":"a8453d2c-0697-4a0d-b412-da321a8434df"},{"source":"f406e632-e8c7-40b8-9c94-f554294a8b59","target":"a4f81891-9fcb-47db-a563-760bc8b9b2f1","id":"b568a843-741a-496d-bc1c-e452981518bb"},{"source":"a4f81891-9fcb-47db-a563-760bc8b9b2f1","target":"17f61e91-0d4f-4d4c-aa90-7617c18574c9","id":"6c653b36-7d13-4f22-bc15-d7c064ba9181"},{"source":"a4f81891-9fcb-47db-a563-760bc8b9b2f1","target":"2710d4e4-d85a-49ab-8cc2-b5cf9fca276c","id":"ccd5204c-5a0d-4762-a6d1-40ac197d2b5b"},{"source":"a4f81891-9fcb-47db-a563-760bc8b9b2f1","target":"8673bcf9-0a5b-42e2-b1be-e6b54cc2a6cc","id":"8f22569f-b7e8-470d-ad9c-11d2f3028402"},{"source":"a4f81891-9fcb-47db-a563-760bc8b9b2f1","target":"81d1678a-8322-4ced-98c5-8cd6994bdfd3","id":"72f48c38-bcf9-4434-814f-9134a1e8c799"},{"source":"a4f81891-9fcb-47db-a563-760bc8b9b2f1","target":"267ad040-4333-4995-826a-447fea93af45","id":"076e298e-4df4-4d0f-99b9-0dbce6c4fc9a"},{"source":"a4f81891-9fcb-47db-a563-760bc8b9b2f1","target":"3b959890-dd2e-42dc-bae3-5e442fb7b6cb","id":"d7110031-d1fd-48a6-a3a5-a85b980660ac"},{"source":"a4f81891-9fcb-47db-a563-760bc8b9b2f1","target":"4d49048f-9d71-49b4-adf9-42a515d48474","id":"fb65bcb9-b3f7-478a-b37f-df953d4c8016"},{"source":"a4f81891-9fcb-47db-a563-760bc8b9b2f1","target":"c62ec58d-642c-4bdb-9e57-60db266ebbc3","id":"882d83fe-5807-4717-86da-769a688c2187"},{"source":"a4f81891-9fcb-47db-a563-760bc8b9b2f1","target":"2e2ec5b7-0101-4f41-9195-99f6909293b2","id":"c9dc4376-c3b2-4fd1-a52a-f03d9ada71cb"},{"source":"17f61e91-0d4f-4d4c-aa90-7617c18574c9","target":"4ef57d4e-5b18-45bf-a259-e87c83bf6d51","id":"36598bab-b240-43b6-920f-67de7fb7ab4a"},{"source":"f4dad33b-227e-4565-8410-4bc12edf36b8","target":"f406e632-e8c7-40b8-9c94-f554294a8b59","id":"81291c4c-0cb3-4fa3-8766-95f5657bd415"},{"source":"f4dad33b-227e-4565-8410-4bc12edf36b8","target":"8e3e27d3-fd79-4b29-86e5-a2e14412c32a","id":"81f5f176-ee89-4b2b-acf0-ebdc9c9b9040"},{"source":"f4dad33b-227e-4565-8410-4bc12edf36b8","target":"a00558bb-1ee9-4c2e-a374-72ba76dd3d41","id":"d67f5c50-6ca6-4d0f-8e1e-3bf162de57d4"},{"source":"f4dad33b-227e-4565-8410-4bc12edf36b8","target":"3753afcd-4ca5-4bb4-8cc8-1c48c68345a3","id":"07c79a20-9537-40e4-9352-bcc2184c8543"},{"source":"f4dad33b-227e-4565-8410-4bc12edf36b8","target":"bcf99a52-d1e3-4a84-9fba-1b2d065930dd","id":"76f3f3e2-bba6-4d7c-a020-2a2d6643973c"},{"source":"f4dad33b-227e-4565-8410-4bc12edf36b8","target":"d1576439-a5e7-468c-8a96-4406a09cabd3","id":"bb21eb63-4bc1-4a03-b033-f3b622ede366"},{"source":"f4dad33b-227e-4565-8410-4bc12edf36b8","target":"8a93aed9-2f32-4c10-85a6-24479e38583c","id":"891ba311-d5cd-425b-ba1e-d62f771647a7"}],"name":"ацетилсалициловая кислота","maxLevel":8,"levelsInfo":{"levelNodesCount":{"0":1,"1":1,"2":1,"3":4,"4":7,"5":1,"6":9,"7":1}},"isParse":true}
            const window_params = {"width":1200,"height":600,"xStep":50,"yStep":100}

            console.log(graphData)

            

            if (graphData){
                const svg = d3.select("svg")
                svg.selectAll("*").remove() // Очистка предыдущего графа

                svg.attr("width",   window_params.width) //Устанавливает атрибут width
                .attr("height",   window_params.height)
                .append("g").attr('class', 'group') //добавляет новый элемент, тег которого передается в метод в качестве параметра

                const svgGroup = svg.select('g.group')

                // Масштабирование и перемещение
                const zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on("zoom", (event)=>{ //Обновление позиционирования элементов при масштабировании
                    svgGroup.attr("transform", event.transform);
                });
                svg.call(zoom);


                const dragstarted = (event, d)=>{
                    if (!event.active) simulation.alphaTarget(0.3).restart(); // Увеличиваем "температуру" симуляции для более плавного движения
                    d.fx = d.x; // Фиксируем позицию узла
                    d.fy = d.y;
                }
                
                const dragged = (event, d)=>{
                    d.fx = event.x; // Обновляем фиксированные координаты узла
                    d.fy = event.y;
                }
                
                const dragended = (event, d)=>{
                    if (!event.active) simulation.alphaTarget(0); // Охлаждаем симуляцию после перетаскивания
                    d.fx = null; // Отпускаем узел, позволяя симуляции снова влиять на его позицию
                    d.fy = null;
                }

                // Создаем обработчик drag
                const drag = d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);


                // Определение маркера стрелки
                svgGroup.append("defs")
                .append("marker")
                .attr("id", "arrowhead")
                .attr("markerWidth", 5) //Размер области, в которой будет отображаться маркер
                .attr("markerHeight", 4)
                .attr("refX", nodeView.r+4)
                .attr("refY", 2)
                .attr("orient", "auto")
                .append("polygon")
                .attr("points", "0 0, 5 2, 0 4")
                .style("fill", colors.link);

                
                //Добавление ссылок
                let links = svgGroup.append("g").attr('class', 'links')
                .selectAll('.link')
                .data(graphData.links) //Добавление данных
                .enter() //Нужен для ввода дополнительных значений (так как data привязывает только первое)
                .append('path')
                .attr('class', 'link')
                .attr('stroke', d=>{
                    //if((d.source.id === selectedNodes.sourseNode && d.target.id === selectedNodes.targetNode)||(d.target.id === selectedNodes.sourseNode && d.source.id === selectedNodes.targetNode)) return colors.selectLink
                    return colors.link
                }) // Цвет линии ребра
                .attr('stroke-width', d=>{
                    //if((d.source.id === selectedNodes.sourseNode && d.target.id === selectedNodes.targetNode)||(d.target.id === selectedNodes.sourseNode && d.source.id === selectedNodes.targetNode)) return 2
                    return 1
                }) // Ширина линии ребра
                .attr("marker-end", "url(#arrowhead)") // Добавление стрелки в конец ребра
                .style('pointer-events', 'none') //(устанавливает стиль) Отключение событий на ребрах (клики и т.д.)

                // Создание узлов
                let nodes = svgGroup.append("g").attr('class', 'nodes')
                .selectAll('.node')
                .data(graphData.nodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .call(drag);

                nodes.append('circle')
                .attr('class', 'node')
                .attr('id', d => d.id)
                .attr('r', d => d.r) // Радиус узла
                .attr('fill', d=>{
                    //if(selectedNodes.sourseNode === d.id || selectedNodes.targetNode === d.id) return colors.selectNode
                    return colors.node
                }) // Цвет заполнения
                .attr("cursor", "pointer")
                .on('click', (event, d) => {
                    // Добавьте логику для обработки клика по узлу
                });

                //Отображение текста v2
                nodes.append('foreignObject')
                .attr('x', d => -d.r * 0.8)
                .attr('y', d => -d.r * 0.8)
                .attr('width', d => d.r * 1.6)
                .attr('height', d => d.r * 1.6)
                .append('xhtml:div')
                .style('display', 'flex')
                .style('justify-content', 'center')
                .style('align-items', 'center')
                .style('width', '100%')
                .style('height', '100%')
                .style('font-size', '5px')
                .style('text-anchor', 'middle')
                .style('word-wrap', 'break-word')
                .style('overflow', 'hidden')
                .style('pointer-events', 'none')
                .text(d => d.name);

                //Создание симуляции силы v3
                const simulation = d3.forceSimulation(graphData.nodes)
                // Связи между узлами
                .force("link", d3.forceLink(graphData.links).id(d => d.id))//.distance(nodeView.r*10)) //!!! Сила в зависимости от количества узлов в уровне!!!!!
                // Отталкивание узлов
                .force("charge", d3.forceManyBody(graphData.nodes).strength(d=>graphData.levelsInfo.levelNodesCount[d.level]*(-100)))//-3000))
                // Центрирование по x
                .force("center", d3.forceCenter( window_params.width / 2,  window_params.height / 2))
                // Выравнивание по уровням
                .force("y", d3.forceY().strength(6)
                    .y(d =>  window_params.height * ((d.level+1) / (graphData.maxLevel-1)))) //!!!!!!!!!!Уровень с большим числом узлов шире, чем с меньшим
                // Отталкивание по x в рамках одного уровня
                .force("x", d3.forceX().strength(0.05)
                    .x( window_params.width / 2))
                // Дополнительная сила для предотвращения наложения узлов
                .force("collision", d3.forceCollide().radius(40));

                // Обновление позиций узлов и связей при каждой итерации симуляции
                //Обновление симуляции
                simulation.on('tick', () => {
                    links.attr("d", d => `M${d.source.x},${d.source.y} L${d.target.x},${d.target.y}`);
                    nodes.attr('transform', d => `translate(${d.x}, ${d.y})`); // Правильная позиция для групп
                });
            }
        </script>
    </body>
</html>