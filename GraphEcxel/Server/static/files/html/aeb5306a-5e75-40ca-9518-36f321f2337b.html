<!DOCTYPE html>
<html>
    <head>
        <title>64d6cd95-cafe-401b-bc07-263557d2e4eb</title>
        <meta charset="utf-8">
        <link rel="stylesheet" href="./css/index.css">
        <style>
            .Graphcontainer{
                width: 98%;
                height: 85vh;

                border: solid 0.5px black;
                border-radius: 7px;
            }

            .svgGraph{
                width: 100%;
                height: 100%;
            }   
        </style>
        <script src="./d3.v7.js"></script>
    </head>
    <body>
        <main>
            <div class="flex jc-center">
                <h1>64d6cd95-cafe-401b-bc07-263557d2e4eb</h1>
            </div>
            <br/>
            <div class='Graphcontainer' >
                <svg class='svgGraph'> </svg>
            </div>
        </main>

        <script>
            const colors = {
                selectNode: "#E8BD6D",
                selectLink: "#8B7474",
                node: "#E9EEF4",
                link: '#B8B5B5'
            }

            const nodeView = {
                r: 30
            }

            const graphData = {"directed":true,"multigraph":false,"graph":{},"nodes":[{"name":"гипогликемическое средство","label":"group","weight":5,"id":"e59ad01e-7ce2-4565-a635-738202dcf3f4","level":0,"r":30,"y":133.33333333333334,"x":1200},{"name":"дапаглифлозин","label":"prepare","weight":5,"id":"64d6cd95-cafe-401b-bc07-263557d2e4eb","level":2,"r":30,"y":393.3333333333333,"x":1200},{"name":"ингибитор натрийзависимый переносчик глюкоза 2 тип","label":"mechanism","weight":5,"id":"70788e56-6615-4529-9887-bf2c9ebd1972","level":3,"r":30,"y":523.3333333333333,"x":150},{"name":"почка","label":"excretion","weight":5,"id":"55930f25-68ba-4182-ab15-845c3fadb350","level":3,"r":30,"y":523.3333333333333,"x":230},{"name":"снижение реабсорбция глюкоза","label":"action","weight":5,"id":"c3ab997b-9ac3-4449-812a-5a43e37e90b9","level":4,"r":30,"y":653.3333333333334,"x":400},{"name":"боль в спине","label":"side_e","weight":5,"id":"cfafaca3-769d-488f-9abd-3f883e3c50a0","level":3,"r":30,"y":523.3333333333333,"x":310},{"name":"головокружение","label":"side_e","weight":5,"id":"310f81f1-cb8b-44d7-9a6e-bb2ded279915","level":8,"r":30,"y":1173.3333333333335,"x":300},{"name":"запор","label":"side_e","weight":5,"id":"61789a0b-408d-4894-a6e8-8c4ae9eccb61","level":7,"r":30,"y":1043.3333333333335,"x":133.33333333333334},{"name":"ингибитор натрийзависимый переносчик глюкоза 2 тип","label":"group","weight":5,"id":"6c137e1e-9e63-483e-a0c2-540a6a0ee527","level":1,"r":30,"y":263.33333333333337,"x":1200},{"name":"снижение реабсорбция натрий","label":"action","weight":5,"id":"b4ca02ff-bcd3-4a06-8741-d43cd9afa582","level":4,"r":30,"y":653.3333333333334,"x":480},{"name":"осмотический диурез","label":"mechanism","weight":5,"id":"02f0e40b-a1b8-40d6-8153-5df236585cee","level":6,"r":30,"y":913.3333333333334,"x":171.42857142857142},{"name":"выведение глюкозы почка","label":"action","weight":5,"id":"3c82fc00-cbb7-4478-9ee6-0406176c26a3","level":5,"r":30,"y":783.3333333333334,"x":400},{"name":"увеличить доставка натрий к дистальный каналец","label":"action","weight":5,"id":"6abc45ab-e51d-47cf-a99e-a5cc36547b22","level":5,"r":30,"y":783.3333333333334,"x":480},{"name":"усилить канальцево-клубочковый обратная связь","label":"action","weight":5,"id":"0bf0f606-1341-4c12-b03e-6c06054e5e94","level":6,"r":30,"y":913.3333333333334,"x":251.42857142857142},{"name":"снижать внутриклубочковый давление","label":"action","weight":5,"id":"13723773-de24-4718-9ba3-a7ff8dbce181","level":7,"r":30,"y":1043.3333333333335,"x":213.33333333333334},{"name":"снижение артериальный давление","label":"action","weight":5,"id":"453bc897-7e8b-4102-9e69-b2f9cf386da9","level":7,"r":30,"y":1043.3333333333335,"x":293.33333333333337},{"name":"повышение гематокрит","label":"side_e","weight":5,"id":"531fbfd6-a449-481b-9eb3-e470a620eac2","level":7,"r":30,"y":1043.3333333333335,"x":373.33333333333337},{"name":"снижение масса тело","label":"side_e","weight":5,"id":"079777ec-8194-4bee-a051-15988974b765","level":6,"r":30,"y":913.3333333333334,"x":331.42857142857144},{"name":"снижать концентрация глюкоза в кровь","label":"action","weight":5,"id":"7c968787-2577-4930-a688-151daf94643e","level":5,"r":30,"y":783.3333333333334,"x":560},{"name":"улучшение функции бета-клеток","label":"action","weight":5,"id":"f7796e9b-ee60-4d5c-a455-ada07438a6b5","level":3,"r":30,"y":523.3333333333333,"x":390},{"name":"вульвовагинит","label":"side_e","weight":5,"id":"3edd74e8-ebdb-4b66-8f0b-48ada0eb93d5","level":6,"r":30,"y":913.3333333333334,"x":411.42857142857144},{"name":"инфекция мочевыводить путь","label":"side_e","weight":5,"id":"347f0db2-e890-44df-bb29-68e5ed951a48","level":6,"r":30,"y":913.3333333333334,"x":491.42857142857144},{"name":"баланит","label":"side_e","weight":5,"id":"af3999ca-072b-4452-93af-f836a5184f37","level":6,"r":30,"y":913.3333333333334,"x":571.4285714285714},{"name":"вульвовагинальный зуд","label":"side_e","weight":5,"id":"eaab09b3-2afc-4795-b867-3730839c9fc2","level":6,"r":30,"y":913.3333333333334,"x":651.4285714285714},{"name":"снижение ОЦК","label":"side_e","weight":5,"id":"b77f7b6a-046b-4f23-b8ec-3ee7819516f4","level":7,"r":30,"y":1043.3333333333335,"x":453.33333333333337},{"name":"жажда","label":"side_e","weight":5,"id":"996ce399-6a97-482e-8974-515cdb229dfd","level":7,"r":30,"y":1043.3333333333335,"x":533.3333333333334},{"name":"сухость в рот","label":"side_e","weight":5,"id":"1edc51e1-b379-4108-96dc-4f3531c29e5f","level":7,"r":30,"y":1043.3333333333335,"x":613.3333333333334},{"name":"сыпь","label":"side_e","weight":5,"id":"09a85b02-0811-43fc-b613-cc0bf66f7cde","level":3,"r":30,"y":523.3333333333333,"x":470},{"name":"дизурия","label":"side_e","weight":5,"id":"1d171baf-ccbf-4f6d-ab65-ad5112651a8c","level":3,"r":30,"y":523.3333333333333,"x":550},{"name":"полиурия","label":"side_e","weight":5,"id":"cbe0eb78-c5ed-45d8-b1c5-06c7c85455dd","level":7,"r":30,"y":1043.3333333333335,"x":693.3333333333334},{"name":"дислипидемия","label":"side_e","weight":5,"id":"9180d506-c968-4b8b-8db5-c2f70208113e","level":7,"r":30,"y":1043.3333333333335,"x":773.3333333333334},{"name":"снижение почечный клиренс креатинин","label":"side_e","weight":5,"id":"88decc37-c954-499e-a66b-05ffc971b8e6","level":8,"r":30,"y":1173.3333333333335,"x":380},{"name":"повышение концентрация мочевина в кровь","label":"side_e","weight":5,"id":"36fdba41-cefd-41ef-a7b6-47df7ae24a79","level":8,"r":30,"y":1173.3333333333335,"x":460},{"name":"повышение концентрация креатинин в кровь","label":"side_e","weight":5,"id":"ddd232e7-fec7-437c-bb84-eafcdc5bc69e","level":8,"r":30,"y":1173.3333333333335,"x":540},{"name":"повышение гематокрит","label":"action","weight":5,"id":"6da24edb-67d5-4a20-aa8c-f5a530c401db","level":4,"r":30,"y":653.3333333333334,"x":560},{"name":"желудочно-кишечный тракт","label":"absorbtion","weight":5,"id":"6c4cab34-4855-4806-bbfa-17ccac167c7e","level":3,"r":30,"y":523.3333333333333,"x":630},{"name":"белок","label":"prot_link","weight":5,"id":"cef6a520-e14f-4934-adf1-900a8e351ff3","level":3,"r":30,"y":523.3333333333333,"x":710}],"links":[{"source":"e59ad01e-7ce2-4565-a635-738202dcf3f4","target":"6c137e1e-9e63-483e-a0c2-540a6a0ee527"},{"source":"64d6cd95-cafe-401b-bc07-263557d2e4eb","target":"cfafaca3-769d-488f-9abd-3f883e3c50a0"},{"source":"64d6cd95-cafe-401b-bc07-263557d2e4eb","target":"1d171baf-ccbf-4f6d-ab65-ad5112651a8c"},{"source":"64d6cd95-cafe-401b-bc07-263557d2e4eb","target":"70788e56-6615-4529-9887-bf2c9ebd1972"},{"source":"64d6cd95-cafe-401b-bc07-263557d2e4eb","target":"55930f25-68ba-4182-ab15-845c3fadb350"},{"source":"64d6cd95-cafe-401b-bc07-263557d2e4eb","target":"f7796e9b-ee60-4d5c-a455-ada07438a6b5"},{"source":"64d6cd95-cafe-401b-bc07-263557d2e4eb","target":"6c4cab34-4855-4806-bbfa-17ccac167c7e"},{"source":"64d6cd95-cafe-401b-bc07-263557d2e4eb","target":"09a85b02-0811-43fc-b613-cc0bf66f7cde"},{"source":"64d6cd95-cafe-401b-bc07-263557d2e4eb","target":"cef6a520-e14f-4934-adf1-900a8e351ff3"},{"source":"70788e56-6615-4529-9887-bf2c9ebd1972","target":"c3ab997b-9ac3-4449-812a-5a43e37e90b9"},{"source":"70788e56-6615-4529-9887-bf2c9ebd1972","target":"b4ca02ff-bcd3-4a06-8741-d43cd9afa582"},{"source":"70788e56-6615-4529-9887-bf2c9ebd1972","target":"6da24edb-67d5-4a20-aa8c-f5a530c401db"},{"source":"c3ab997b-9ac3-4449-812a-5a43e37e90b9","target":"3c82fc00-cbb7-4478-9ee6-0406176c26a3"},{"source":"c3ab997b-9ac3-4449-812a-5a43e37e90b9","target":"7c968787-2577-4930-a688-151daf94643e"},{"source":"6c137e1e-9e63-483e-a0c2-540a6a0ee527","target":"64d6cd95-cafe-401b-bc07-263557d2e4eb"},{"source":"b4ca02ff-bcd3-4a06-8741-d43cd9afa582","target":"02f0e40b-a1b8-40d6-8153-5df236585cee"},{"source":"b4ca02ff-bcd3-4a06-8741-d43cd9afa582","target":"6abc45ab-e51d-47cf-a99e-a5cc36547b22"},{"source":"02f0e40b-a1b8-40d6-8153-5df236585cee","target":"531fbfd6-a449-481b-9eb3-e470a620eac2"},{"source":"02f0e40b-a1b8-40d6-8153-5df236585cee","target":"b77f7b6a-046b-4f23-b8ec-3ee7819516f4"},{"source":"02f0e40b-a1b8-40d6-8153-5df236585cee","target":"61789a0b-408d-4894-a6e8-8c4ae9eccb61"},{"source":"02f0e40b-a1b8-40d6-8153-5df236585cee","target":"1edc51e1-b379-4108-96dc-4f3531c29e5f"},{"source":"02f0e40b-a1b8-40d6-8153-5df236585cee","target":"cbe0eb78-c5ed-45d8-b1c5-06c7c85455dd"},{"source":"02f0e40b-a1b8-40d6-8153-5df236585cee","target":"996ce399-6a97-482e-8974-515cdb229dfd"},{"source":"02f0e40b-a1b8-40d6-8153-5df236585cee","target":"453bc897-7e8b-4102-9e69-b2f9cf386da9"},{"source":"02f0e40b-a1b8-40d6-8153-5df236585cee","target":"9180d506-c968-4b8b-8db5-c2f70208113e"},{"source":"3c82fc00-cbb7-4478-9ee6-0406176c26a3","target":"02f0e40b-a1b8-40d6-8153-5df236585cee"},{"source":"3c82fc00-cbb7-4478-9ee6-0406176c26a3","target":"079777ec-8194-4bee-a051-15988974b765"},{"source":"3c82fc00-cbb7-4478-9ee6-0406176c26a3","target":"347f0db2-e890-44df-bb29-68e5ed951a48"},{"source":"3c82fc00-cbb7-4478-9ee6-0406176c26a3","target":"3edd74e8-ebdb-4b66-8f0b-48ada0eb93d5"},{"source":"3c82fc00-cbb7-4478-9ee6-0406176c26a3","target":"af3999ca-072b-4452-93af-f836a5184f37"},{"source":"3c82fc00-cbb7-4478-9ee6-0406176c26a3","target":"eaab09b3-2afc-4795-b867-3730839c9fc2"},{"source":"6abc45ab-e51d-47cf-a99e-a5cc36547b22","target":"0bf0f606-1341-4c12-b03e-6c06054e5e94"},{"source":"0bf0f606-1341-4c12-b03e-6c06054e5e94","target":"13723773-de24-4718-9ba3-a7ff8dbce181"},{"source":"453bc897-7e8b-4102-9e69-b2f9cf386da9","target":"310f81f1-cb8b-44d7-9a6e-bb2ded279915"},{"source":"b77f7b6a-046b-4f23-b8ec-3ee7819516f4","target":"88decc37-c954-499e-a66b-05ffc971b8e6"},{"source":"b77f7b6a-046b-4f23-b8ec-3ee7819516f4","target":"36fdba41-cefd-41ef-a7b6-47df7ae24a79"},{"source":"b77f7b6a-046b-4f23-b8ec-3ee7819516f4","target":"ddd232e7-fec7-437c-bb84-eafcdc5bc69e"}],"name":["64d6cd95-cafe-401b-bc07-263557d2e4eb"],"maxLevel":9,"levelsInfo":{"levelNodesCount":{"0":1,"1":1,"2":1,"3":8,"4":3,"5":3,"6":7,"7":9,"8":4}},"isParse":true}
            const window_params = {"width":1200,"height":600,"xStep":50,"yStep":100}

            console.log(graphData)

            

            if (graphData){
                const svg = d3.select("svg")
                svg.selectAll("*").remove() // Очистка предыдущего графа

                svg.attr("width",   window_params.width) //Устанавливает атрибут width
                .attr("height",   window_params.height)
                .append("g").attr('class', 'group') //добавляет новый элемент, тег которого передается в метод в качестве параметра

                const svgGroup = svg.select('g.group')

                // Масштабирование и перемещение
                const zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on("zoom", (event)=>{ //Обновление позиционирования элементов при масштабировании
                    svgGroup.attr("transform", event.transform);
                });
                svg.call(zoom);


                const dragstarted = (event, d)=>{
                    if (!event.active) simulation.alphaTarget(0.3).restart(); // Увеличиваем "температуру" симуляции для более плавного движения
                    d.fx = d.x; // Фиксируем позицию узла
                    d.fy = d.y;
                }
                
                const dragged = (event, d)=>{
                    d.fx = event.x; // Обновляем фиксированные координаты узла
                    d.fy = event.y;
                }
                
                const dragended = (event, d)=>{
                    if (!event.active) simulation.alphaTarget(0); // Охлаждаем симуляцию после перетаскивания
                    d.fx = null; // Отпускаем узел, позволяя симуляции снова влиять на его позицию
                    d.fy = null;
                }

                // Создаем обработчик drag
                const drag = d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);


                // Определение маркера стрелки
                svgGroup.append("defs")
                .append("marker")
                .attr("id", "arrowhead")
                .attr("markerWidth", 5) //Размер области, в которой будет отображаться маркер
                .attr("markerHeight", 4)
                .attr("refX", nodeView.r+4)
                .attr("refY", 2)
                .attr("orient", "auto")
                .append("polygon")
                .attr("points", "0 0, 5 2, 0 4")
                .style("fill", colors.link);

                
                //Добавление ссылок
                let links = svgGroup.append("g").attr('class', 'links')
                .selectAll('.link')
                .data(graphData.links) //Добавление данных
                .enter() //Нужен для ввода дополнительных значений (так как data привязывает только первое)
                .append('path')
                .attr('class', 'link')
                .attr('stroke', d=>{
                    //if((d.source.id === selectedNodes.sourseNode && d.target.id === selectedNodes.targetNode)||(d.target.id === selectedNodes.sourseNode && d.source.id === selectedNodes.targetNode)) return colors.selectLink
                    return colors.link
                }) // Цвет линии ребра
                .attr('stroke-width', d=>{
                    //if((d.source.id === selectedNodes.sourseNode && d.target.id === selectedNodes.targetNode)||(d.target.id === selectedNodes.sourseNode && d.source.id === selectedNodes.targetNode)) return 2
                    return 1
                }) // Ширина линии ребра
                .attr("marker-end", "url(#arrowhead)") // Добавление стрелки в конец ребра
                .style('pointer-events', 'none') //(устанавливает стиль) Отключение событий на ребрах (клики и т.д.)

                // Создание узлов
                let nodes = svgGroup.append("g").attr('class', 'nodes')
                .selectAll('.node')
                .data(graphData.nodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .call(drag);

                nodes.append('circle')
                .attr('class', 'node')
                .attr('id', d => d.id)
                .attr('r', d => d.r) // Радиус узла
                .attr('fill', d=>{
                    //if(selectedNodes.sourseNode === d.id || selectedNodes.targetNode === d.id) return colors.selectNode
                    return colors.node
                }) // Цвет заполнения
                .attr("cursor", "pointer")
                .on('click', (event, d) => {
                    // Добавьте логику для обработки клика по узлу
                });

                //Отображение текста v2
                nodes.append('foreignObject')
                .attr('x', d => -d.r * 0.8)
                .attr('y', d => -d.r * 0.8)
                .attr('width', d => d.r * 1.6)
                .attr('height', d => d.r * 1.6)
                .append('xhtml:div')
                .style('display', 'flex')
                .style('justify-content', 'center')
                .style('align-items', 'center')
                .style('width', '100%')
                .style('height', '100%')
                .style('font-size', '5px')
                .style('text-anchor', 'middle')
                .style('word-wrap', 'break-word')
                .style('overflow', 'hidden')
                .style('pointer-events', 'none')
                .text(d => d.name);

                //Создание симуляции силы v3
                const simulation = d3.forceSimulation(graphData.nodes)
                // Связи между узлами
                .force("link", d3.forceLink(graphData.links).id(d => d.id))//.distance(nodeView.r*10)) //!!! Сила в зависимости от количества узлов в уровне!!!!!
                // Отталкивание узлов
                .force("charge", d3.forceManyBody(graphData.nodes).strength(d=>graphData.levelsInfo.levelNodesCount[d.level]*(-100)))//-3000))
                // Центрирование по x
                .force("center", d3.forceCenter( window_params.width / 2,  window_params.height / 2))
                // Выравнивание по уровням
                .force("y", d3.forceY().strength(6)
                    .y(d =>  window_params.height * ((d.level+1) / (graphData.maxLevel-1)))) //!!!!!!!!!!Уровень с большим числом узлов шире, чем с меньшим
                // Отталкивание по x в рамках одного уровня
                .force("x", d3.forceX().strength(0.05)
                    .x( window_params.width / 2))
                // Дополнительная сила для предотвращения наложения узлов
                .force("collision", d3.forceCollide().radius(40));

                // Обновление позиций узлов и связей при каждой итерации симуляции
                //Обновление симуляции
                simulation.on('tick', () => {
                    links.attr("d", d => `M${d.source.x},${d.source.y} L${d.target.x},${d.target.y}`);
                    nodes.attr('transform', d => `translate(${d.x}, ${d.y})`); // Правильная позиция для групп
                });
            }
        </script>
    </body>
</html>