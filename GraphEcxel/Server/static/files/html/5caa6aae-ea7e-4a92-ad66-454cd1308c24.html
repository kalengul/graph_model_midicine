<!DOCTYPE html>
<html>
    <head>
        <title>cf32fe6c-471f-4c1a-a485-0cb61b895cb6</title>
        <meta charset="utf-8">
        <link rel="stylesheet" href="./css/index.css">
        <style>
            .Graphcontainer{
                width: 98%;
                height: 85vh;

                border: solid 0.5px black;
                border-radius: 7px;
            }

            .svgGraph{
                width: 100%;
                height: 100%;
            }   
        </style>
        <script src="./d3.v7.js"></script>
    </head>
    <body>
        <main>
            <div class="flex jc-center">
                <h1>cf32fe6c-471f-4c1a-a485-0cb61b895cb6</h1>
            </div>
            <br/>
            <div class='Graphcontainer' >
                <svg class='svgGraph'> </svg>
            </div>
        </main>

        <script>
            const colors = {
                selectNode: "#E8BD6D",
                selectLink: "#8B7474",
                node: "#E9EEF4",
                link: '#B8B5B5'
            }

            const nodeView = {
                r: 30
            }

            const graphData = {"directed":true,"multigraph":false,"graph":{},"nodes":[{"name":"триметазидин","label":"prepare","weight":5,"id":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","level":1,"r":30,"y":263.33333333333337,"x":1200},{"name":"предотвращать снижение внутриклеточный концентрация аденозинтрифосфат","label":"mechanism","weight":5,"id":"76afcafe-2ba1-4807-b7e9-0cee2ae640ca","level":4,"r":30,"y":653.3333333333334,"x":1200},{"name":"обеспечивать нормальный функционирование мембранный ионный канал","label":"action","weight":5,"id":"a6d0159e-fc31-4b41-9a41-6b971857fb14","level":6,"r":30,"y":913.3333333333334,"x":240},{"name":"ингибировать β-окисление жирный кислота","label":"mechanism","weight":5,"id":"6aa2169a-5d68-4aee-921d-77d0b62f061f","level":3,"r":30,"y":523.3333333333333,"x":1200},{"name":"сохранять уровень высокоэнергетический фосфат в клетка миокард","label":"action","weight":5,"id":"896855f5-07fb-42eb-9986-a3d8b2013b93","level":7,"r":30,"y":1043.3333333333335,"x":1200},{"name":"почка","label":"excretion","weight":5,"id":"8b2aa8be-9cbd-4c6c-b9c3-959c5b9b9ec6","level":2,"r":30,"y":393.3333333333333,"x":37.5},{"name":"головокружение","label":"side_e","weight":5,"id":"11f6b0ca-d7ec-4e5a-b82d-390579c9d244","level":2,"r":30,"y":393.3333333333333,"x":117.5},{"name":"головной боль","label":"side_e","weight":5,"id":"d2f58703-4289-42fd-a07d-17b603bbff45","level":2,"r":30,"y":393.3333333333333,"x":197.5},{"name":"симптом паркинсонизм","label":"side_e","weight":5,"id":"7b69ddd7-cf08-4bca-b51c-18693aedd8d5","level":2,"r":30,"y":393.3333333333333,"x":277.5},{"name":"тремор","label":"side_e","weight":5,"id":"588f7941-e4be-4f99-8e77-3fdb56de79cd","level":2,"r":30,"y":393.3333333333333,"x":357.5},{"name":"акинезия","label":"side_e","weight":5,"id":"b10d9521-5fc7-463b-92e4-3ff7dbd4c51d","level":2,"r":30,"y":393.3333333333333,"x":437.5},{"name":"повышение тонус","label":"side_e","weight":5,"id":"7a3bc998-edb9-458c-acf5-4a9395d87f56","level":2,"r":30,"y":393.3333333333333,"x":517.5},{"name":"неустойчивость походка","label":"side_e","weight":5,"id":"15fce515-40ee-47af-971c-eb2ac2979781","level":2,"r":30,"y":393.3333333333333,"x":597.5},{"name":"синдром «беспокойный нога»","label":"side_e","weight":5,"id":"6ca8954e-ddb6-44e8-aa7e-2bf5ec9681e5","level":2,"r":30,"y":393.3333333333333,"x":677.5},{"name":"бессонница","label":"side_e","weight":5,"id":"70c71378-324b-4502-b76c-0ab8420a4fbe","level":2,"r":30,"y":393.3333333333333,"x":757.5},{"name":"сонливость","label":"side_e","weight":5,"id":"ea488ce1-e5d9-499f-b319-9581b665fc0e","level":2,"r":30,"y":393.3333333333333,"x":837.5},{"name":"вертигоощущение сердцебиение","label":"side_e","weight":5,"id":"07d2c29e-61ef-4a89-b5c1-fff438c7f0a1","level":2,"r":30,"y":393.3333333333333,"x":917.5},{"name":"экстрасистолия","label":"side_e","weight":5,"id":"8bfa8753-af26-4cf7-a0aa-eff4d946f978","level":2,"r":30,"y":393.3333333333333,"x":997.5},{"name":"тахакардия","label":"side_e","weight":5,"id":"21eebcd4-6491-41ed-ad3c-78c519196aa1","level":2,"r":30,"y":393.3333333333333,"x":1077.5},{"name":"артериальный гипотензия","label":"side_e","weight":5,"id":"21a1a4a2-7e82-4fe4-a170-cffeb969692c","level":2,"r":30,"y":393.3333333333333,"x":1157.5},{"name":"ортостатический гипотензия","label":"side_e","weight":5,"id":"f0f1b494-6543-4a01-9e17-9f1a1378880d","level":2,"r":30,"y":393.3333333333333,"x":1237.5},{"name":"«прилив» кровь к кожа лицо","label":"side_e","weight":5,"id":"e3d5dcb2-556a-4a2b-9f9d-feeaa453b14c","level":2,"r":30,"y":393.3333333333333,"x":1317.5},{"name":"боль в живот","label":"side_e","weight":5,"id":"609cc474-be32-4ff4-b393-000bba479694","level":2,"r":30,"y":393.3333333333333,"x":1397.5},{"name":"диарея","label":"side_e","weight":5,"id":"24cfb004-5456-4365-ae36-6a73cfa1b769","level":2,"r":30,"y":393.3333333333333,"x":1477.5},{"name":"диспепсия","label":"side_e","weight":5,"id":"930fcd32-5542-466e-8ad3-c953d47fae6d","level":2,"r":30,"y":393.3333333333333,"x":1557.5},{"name":"тошнота","label":"side_e","weight":5,"id":"70a0426e-d38a-4940-afe4-bd586a2249f2","level":2,"r":30,"y":393.3333333333333,"x":1637.5},{"name":"рвота","label":"side_e","weight":5,"id":"8d96192d-8cc5-4f83-8ce7-112b377aa20c","level":2,"r":30,"y":393.3333333333333,"x":1717.5},{"name":"нарушение с стороны кожа","label":"side_e","weight":5,"id":"7378385c-4a98-4fc2-be77-7149b77c4c77","level":2,"r":30,"y":393.3333333333333,"x":1797.5},{"name":"кожный сыпь","label":"side_e","weight":5,"id":"e9d5abed-19c8-4b6d-92f9-5beab6871ab7","level":2,"r":30,"y":393.3333333333333,"x":1877.5},{"name":"кожный зуд","label":"side_e","weight":5,"id":"4ccb7e85-d6c7-4d9a-8498-ac05015ad12b","level":2,"r":30,"y":393.3333333333333,"x":1957.5},{"name":"крапивница","label":"side_e","weight":5,"id":"f7429cdf-99fc-4fa9-9a50-d002a752a81a","level":2,"r":30,"y":393.3333333333333,"x":2037.5},{"name":"ангионевротический отёк","label":"side_e","weight":5,"id":"51ce5e3c-194d-47bf-be5a-171227606287","level":2,"r":30,"y":393.3333333333333,"x":2117.5},{"name":"астения","label":"side_e","weight":5,"id":"bc9efa3e-809a-42ad-8e5e-617b5f466f6e","level":2,"r":30,"y":393.3333333333333,"x":2197.5},{"name":"внутрь","label":"absorbtion","weight":5,"id":"87581073-23c7-4be1-9b9c-7280f32854d8","level":2,"r":30,"y":393.3333333333333,"x":2277.5},{"name":"средство для лечение заболевание сердце","label":"group","weight":5,"id":"ed9759df-01bf-48e2-8414-a60a96efdd35","level":0,"r":30,"y":133.33333333333334,"x":1200},{"name":"трансмембранный перенос ион","label":"action","weight":5,"id":"f3615ad9-4821-43a1-886d-cde5ac2ecbff","level":6,"r":30,"y":913.3333333333334,"x":320},{"name":"сохранение клеточный гомеостаз","label":"action","weight":5,"id":"4e2e883b-7ba0-4f12-9f8c-48957386e882","level":6,"r":30,"y":913.3333333333334,"x":400},{"name":"блокировка длинноцепочечный 3-кетоацил-коа-тиолаза","label":"mechanism","weight":5,"id":"842b1fbf-a65f-4082-91d5-9b90ed20cdda","level":2,"r":30,"y":393.3333333333333,"x":2357.5},{"name":"сохранять энергетический метаболизм клеток","label":"action","weight":5,"id":"2cce1289-908b-4bd9-9ea7-11516ce3d361","level":5,"r":30,"y":783.3333333333334,"x":1200},{"name":"антиишемический эффект","label":"action","weight":5,"id":"3d58a5f9-2ad7-4fd7-a6c6-fdbd675cbc1a","level":8,"r":30,"y":1173.3333333333335,"x":1200},{"name":"запор","label":"side_e","weight":5,"id":"b4b64c0c-2e84-4748-9123-3c05be519b56","level":2,"r":30,"y":393.3333333333333,"x":2437.5},{"name":"гепатит","label":"side_e","weight":5,"id":"fbde30f5-3541-4785-b6f5-0563ad47c44e","level":2,"r":30,"y":393.3333333333333,"x":2517.5},{"name":"трансмембранный перенос ион натрий","label":"action","weight":5,"id":"b5439f4e-f1c4-4377-8918-4461048f31d0","level":6,"r":30,"y":913.3333333333334,"x":480},{"name":"трансмембранный перенос ион калий","label":"action","weight":5,"id":"a6df46f3-a9d1-45c2-86be-ef46bc1db563","level":6,"r":30,"y":913.3333333333334,"x":560}],"links":[{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"11f6b0ca-d7ec-4e5a-b82d-390579c9d244"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"d2f58703-4289-42fd-a07d-17b603bbff45"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"7b69ddd7-cf08-4bca-b51c-18693aedd8d5"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"588f7941-e4be-4f99-8e77-3fdb56de79cd"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"b10d9521-5fc7-463b-92e4-3ff7dbd4c51d"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"7a3bc998-edb9-458c-acf5-4a9395d87f56"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"15fce515-40ee-47af-971c-eb2ac2979781"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"6ca8954e-ddb6-44e8-aa7e-2bf5ec9681e5"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"70c71378-324b-4502-b76c-0ab8420a4fbe"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"ea488ce1-e5d9-499f-b319-9581b665fc0e"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"07d2c29e-61ef-4a89-b5c1-fff438c7f0a1"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"8bfa8753-af26-4cf7-a0aa-eff4d946f978"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"21eebcd4-6491-41ed-ad3c-78c519196aa1"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"21a1a4a2-7e82-4fe4-a170-cffeb969692c"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"f0f1b494-6543-4a01-9e17-9f1a1378880d"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"e3d5dcb2-556a-4a2b-9f9d-feeaa453b14c"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"609cc474-be32-4ff4-b393-000bba479694"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"24cfb004-5456-4365-ae36-6a73cfa1b769"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"930fcd32-5542-466e-8ad3-c953d47fae6d"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"70a0426e-d38a-4940-afe4-bd586a2249f2"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"8d96192d-8cc5-4f83-8ce7-112b377aa20c"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"7378385c-4a98-4fc2-be77-7149b77c4c77"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"e9d5abed-19c8-4b6d-92f9-5beab6871ab7"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"4ccb7e85-d6c7-4d9a-8498-ac05015ad12b"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"f7429cdf-99fc-4fa9-9a50-d002a752a81a"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"51ce5e3c-194d-47bf-be5a-171227606287"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"bc9efa3e-809a-42ad-8e5e-617b5f466f6e"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"b4b64c0c-2e84-4748-9123-3c05be519b56"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"fbde30f5-3541-4785-b6f5-0563ad47c44e"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"87581073-23c7-4be1-9b9c-7280f32854d8"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"8b2aa8be-9cbd-4c6c-b9c3-959c5b9b9ec6"},{"source":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6","target":"842b1fbf-a65f-4082-91d5-9b90ed20cdda"},{"source":"76afcafe-2ba1-4807-b7e9-0cee2ae640ca","target":"2cce1289-908b-4bd9-9ea7-11516ce3d361"},{"source":"a6d0159e-fc31-4b41-9a41-6b971857fb14","target":"896855f5-07fb-42eb-9986-a3d8b2013b93"},{"source":"6aa2169a-5d68-4aee-921d-77d0b62f061f","target":"76afcafe-2ba1-4807-b7e9-0cee2ae640ca"},{"source":"896855f5-07fb-42eb-9986-a3d8b2013b93","target":"3d58a5f9-2ad7-4fd7-a6c6-fdbd675cbc1a"},{"source":"ed9759df-01bf-48e2-8414-a60a96efdd35","target":"cf32fe6c-471f-4c1a-a485-0cb61b895cb6"},{"source":"f3615ad9-4821-43a1-886d-cde5ac2ecbff","target":"896855f5-07fb-42eb-9986-a3d8b2013b93"},{"source":"4e2e883b-7ba0-4f12-9f8c-48957386e882","target":"896855f5-07fb-42eb-9986-a3d8b2013b93"},{"source":"842b1fbf-a65f-4082-91d5-9b90ed20cdda","target":"6aa2169a-5d68-4aee-921d-77d0b62f061f"},{"source":"2cce1289-908b-4bd9-9ea7-11516ce3d361","target":"a6d0159e-fc31-4b41-9a41-6b971857fb14"},{"source":"2cce1289-908b-4bd9-9ea7-11516ce3d361","target":"4e2e883b-7ba0-4f12-9f8c-48957386e882"},{"source":"2cce1289-908b-4bd9-9ea7-11516ce3d361","target":"f3615ad9-4821-43a1-886d-cde5ac2ecbff"},{"source":"2cce1289-908b-4bd9-9ea7-11516ce3d361","target":"b5439f4e-f1c4-4377-8918-4461048f31d0"},{"source":"2cce1289-908b-4bd9-9ea7-11516ce3d361","target":"a6df46f3-a9d1-45c2-86be-ef46bc1db563"}],"name":["cf32fe6c-471f-4c1a-a485-0cb61b895cb6"],"maxLevel":9,"levelsInfo":{"levelNodesCount":{"0":1,"1":1,"2":32,"3":1,"4":1,"5":1,"6":5,"7":1,"8":1}},"isParse":true}
            const window_params = {"width":1200,"height":600,"xStep":50,"yStep":100}

            console.log(graphData)

            

            if (graphData){
                const svg = d3.select("svg")
                svg.selectAll("*").remove() // Очистка предыдущего графа

                svg.attr("width",   window_params.width) //Устанавливает атрибут width
                .attr("height",   window_params.height)
                .append("g").attr('class', 'group') //добавляет новый элемент, тег которого передается в метод в качестве параметра

                const svgGroup = svg.select('g.group')

                // Масштабирование и перемещение
                const zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on("zoom", (event)=>{ //Обновление позиционирования элементов при масштабировании
                    svgGroup.attr("transform", event.transform);
                });
                svg.call(zoom);


                const dragstarted = (event, d)=>{
                    if (!event.active) simulation.alphaTarget(0.3).restart(); // Увеличиваем "температуру" симуляции для более плавного движения
                    d.fx = d.x; // Фиксируем позицию узла
                    d.fy = d.y;
                }
                
                const dragged = (event, d)=>{
                    d.fx = event.x; // Обновляем фиксированные координаты узла
                    d.fy = event.y;
                }
                
                const dragended = (event, d)=>{
                    if (!event.active) simulation.alphaTarget(0); // Охлаждаем симуляцию после перетаскивания
                    d.fx = null; // Отпускаем узел, позволяя симуляции снова влиять на его позицию
                    d.fy = null;
                }

                // Создаем обработчик drag
                const drag = d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);


                // Определение маркера стрелки
                svgGroup.append("defs")
                .append("marker")
                .attr("id", "arrowhead")
                .attr("markerWidth", 5) //Размер области, в которой будет отображаться маркер
                .attr("markerHeight", 4)
                .attr("refX", nodeView.r+4)
                .attr("refY", 2)
                .attr("orient", "auto")
                .append("polygon")
                .attr("points", "0 0, 5 2, 0 4")
                .style("fill", colors.link);

                
                //Добавление ссылок
                let links = svgGroup.append("g").attr('class', 'links')
                .selectAll('.link')
                .data(graphData.links) //Добавление данных
                .enter() //Нужен для ввода дополнительных значений (так как data привязывает только первое)
                .append('path')
                .attr('class', 'link')
                .attr('stroke', d=>{
                    //if((d.source.id === selectedNodes.sourseNode && d.target.id === selectedNodes.targetNode)||(d.target.id === selectedNodes.sourseNode && d.source.id === selectedNodes.targetNode)) return colors.selectLink
                    return colors.link
                }) // Цвет линии ребра
                .attr('stroke-width', d=>{
                    //if((d.source.id === selectedNodes.sourseNode && d.target.id === selectedNodes.targetNode)||(d.target.id === selectedNodes.sourseNode && d.source.id === selectedNodes.targetNode)) return 2
                    return 1
                }) // Ширина линии ребра
                .attr("marker-end", "url(#arrowhead)") // Добавление стрелки в конец ребра
                .style('pointer-events', 'none') //(устанавливает стиль) Отключение событий на ребрах (клики и т.д.)

                // Создание узлов
                let nodes = svgGroup.append("g").attr('class', 'nodes')
                .selectAll('.node')
                .data(graphData.nodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .call(drag);

                nodes.append('circle')
                .attr('class', 'node')
                .attr('id', d => d.id)
                .attr('r', d => d.r) // Радиус узла
                .attr('fill', d=>{
                    //if(selectedNodes.sourseNode === d.id || selectedNodes.targetNode === d.id) return colors.selectNode
                    return colors.node
                }) // Цвет заполнения
                .attr("cursor", "pointer")
                .on('click', (event, d) => {
                    // Добавьте логику для обработки клика по узлу
                });

                //Отображение текста v2
                nodes.append('foreignObject')
                .attr('x', d => -d.r * 0.8)
                .attr('y', d => -d.r * 0.8)
                .attr('width', d => d.r * 1.6)
                .attr('height', d => d.r * 1.6)
                .append('xhtml:div')
                .style('display', 'flex')
                .style('justify-content', 'center')
                .style('align-items', 'center')
                .style('width', '100%')
                .style('height', '100%')
                .style('font-size', '5px')
                .style('text-anchor', 'middle')
                .style('word-wrap', 'break-word')
                .style('overflow', 'hidden')
                .style('pointer-events', 'none')
                .text(d => d.name);

                //Создание симуляции силы v3
                const simulation = d3.forceSimulation(graphData.nodes)
                // Связи между узлами
                .force("link", d3.forceLink(graphData.links).id(d => d.id))//.distance(nodeView.r*10)) //!!! Сила в зависимости от количества узлов в уровне!!!!!
                // Отталкивание узлов
                .force("charge", d3.forceManyBody(graphData.nodes).strength(d=>graphData.levelsInfo.levelNodesCount[d.level]*(-100)))//-3000))
                // Центрирование по x
                .force("center", d3.forceCenter( window_params.width / 2,  window_params.height / 2))
                // Выравнивание по уровням
                .force("y", d3.forceY().strength(6)
                    .y(d =>  window_params.height * ((d.level+1) / (graphData.maxLevel-1)))) //!!!!!!!!!!Уровень с большим числом узлов шире, чем с меньшим
                // Отталкивание по x в рамках одного уровня
                .force("x", d3.forceX().strength(0.05)
                    .x( window_params.width / 2))
                // Дополнительная сила для предотвращения наложения узлов
                .force("collision", d3.forceCollide().radius(40));

                // Обновление позиций узлов и связей при каждой итерации симуляции
                //Обновление симуляции
                simulation.on('tick', () => {
                    links.attr("d", d => `M${d.source.x},${d.source.y} L${d.target.x},${d.target.y}`);
                    nodes.attr('transform', d => `translate(${d.x}, ${d.y})`); // Правильная позиция для групп
                });
            }
        </script>
    </body>
</html>