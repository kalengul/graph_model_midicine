<!DOCTYPE html>
<html>
    <head>
        <title>метформин</title>
        <meta charset="utf-8">
        <link rel="stylesheet" href="./css/index.css">
        <style>
            .Graphcontainer{
                width: 98%;
                height: 85vh;

                border: solid 0.5px black;
                border-radius: 7px;
            }

            .svgGraph{
                width: 100%;
                height: 100%;
            }   
        </style>
        <script src="./d3.v7.js"></script>
    </head>
    <body>
        <main>
            <div class="flex jc-center">
                <h1>метформин</h1>
            </div>
            <br/>
            <div class='Graphcontainer' >
                <svg class='svgGraph'> </svg>
            </div>
        </main>

        <script>
            const colors = {
                selectNode: "#E8BD6D",
                selectLink: "#8B7474",
                node: "#E9EEF4",
                link: '#B8B5B5'
            }

            const nodeView = {
                r: 30
            }

            const graphData = {"directed":true,"multigraph":false,"graph":{},"nodes":[{"label":"group","weight":5,"id":"dbbd5ffa-8bff-4e56-a7b5-48b31105d4ee","name":"средство для лечение сахарный диабет","level":0,"r":30,"y":137.5,"x":80},{"label":"group","weight":5,"id":"0eef3e2b-6580-4fde-b99e-8e4e12bb274a","name":"гипогликемический средство","level":1,"r":30,"y":267.5,"x":1200},{"label":"prepare","weight":5,"id":"ef30a80e-95fa-4835-8a35-1552522d4b53","name":"инсулин","level":5,"r":30,"y":787.5,"x":400},{"label":"group","weight":5,"id":"f4d0dc59-40ee-4db6-9c91-868e6124b4a9","name":"бигуанид","level":2,"r":30,"y":397.5,"x":1200},{"label":"prepare","weight":5,"id":"6d71331a-9beb-430c-976a-fb74cde18aab","name":"метформин","level":3,"r":30,"y":527.5,"x":1200},{"label":"mechanism","weight":5,"id":"e7d0da1b-7e73-4cfd-ad8c-63486bafc6fb","name":"гипогликемический действие","level":6,"r":30,"y":917.5,"x":1200},{"label":"side_e","weight":5,"id":"054d03ee-358c-4137-a923-0db4d820e2bf","name":"недостаточность витамин в 12","level":0,"r":30,"y":137.5,"x":160},{"label":"side_e","weight":5,"id":"b80a51bc-05e4-4480-9bdc-00d8c14496ea","name":"мегалобластной анемия","level":0,"r":30,"y":137.5,"x":240},{"label":"side_e","weight":5,"id":"5ca38204-00cb-4b49-b7db-dc06f59b4334","name":"лактоацидоз","level":0,"r":30,"y":137.5,"x":320},{"label":"side_e","weight":5,"id":"9b820cab-07cd-4b17-b4b8-d01e6337e39d","name":"металлический привкус в рот","level":0,"r":30,"y":137.5,"x":400},{"label":"side_e","weight":5,"id":"781c2b98-db28-40b6-98cc-e79319ea96c1","name":"тошнота","level":0,"r":30,"y":137.5,"x":480},{"label":"side_e","weight":5,"id":"90af0671-37e0-4025-8866-9c95ecb662f3","name":"рвота","level":0,"r":30,"y":137.5,"x":560},{"label":"side_e","weight":5,"id":"5c4b68ec-2aba-45e2-ab87-98985cc077e6","name":"диарея","level":0,"r":30,"y":137.5,"x":640},{"label":"side_e","weight":5,"id":"198a170f-dd50-49aa-b643-fb44c7983a44","name":"боль в живот","level":0,"r":30,"y":137.5,"x":720},{"label":"side_e","weight":5,"id":"b695e3d3-bd93-4fb3-8fa4-a368dccd4a72","name":"отсутствие аппетит","level":0,"r":30,"y":137.5,"x":800},{"label":"side_e","weight":5,"id":"bbdfcf54-72b1-44b2-b78e-ac235840c1ef","name":"гепатит","level":0,"r":30,"y":137.5,"x":880},{"label":"side_e","weight":5,"id":"4e5fd18a-ad6f-4143-9859-2607217a4c20","name":"кожный реакция","level":0,"r":30,"y":137.5,"x":960},{"label":"side_e","weight":5,"id":"30424f3a-df0b-45e9-b09e-e208e0752935","name":"эритема (покраснение кожа)","level":0,"r":30,"y":137.5,"x":1040},{"label":"side_e","weight":5,"id":"cfb9e107-0cad-4cc3-b3fa-f7fa9ee35dfa","name":"зуд","level":0,"r":30,"y":137.5,"x":1120},{"label":"side_e","weight":5,"id":"f5023231-caaf-4261-b391-dc1845b604f5","name":"крапивница","level":0,"r":30,"y":137.5,"x":1200},{"label":"absorbtion","weight":5,"id":"322e6d7d-a512-445e-9920-55be9c207d48","name":"желудочно-кишечный тракт","level":4,"r":30,"y":657.5,"x":100},{"label":"mechanism","weight":5,"id":"de3ec42d-b3b6-492a-905c-3bde0e9786f5","name":"снижать выработка глюкоза печень","level":5,"r":30,"y":787.5,"x":480},{"label":"mechanism","weight":5,"id":"1492c96e-bd01-426e-960f-dcaa97778841","name":"задерживать всасывание глюкоза в кишечник","level":4,"r":30,"y":657.5,"x":180},{"label":"mechanism","weight":5,"id":"9f5a0dd1-c73c-4a63-b6e1-a6f50c541e90","name":"стимулировать синтез внутриклеточный гликоген","level":5,"r":30,"y":787.5,"x":560},{"label":"mechanism","weight":5,"id":"1510a291-6129-4d6e-9350-e134952a190e","name":"воздействовать на гликогенсинтаз","level":4,"r":30,"y":657.5,"x":260},{"label":"mechanism","weight":5,"id":"26480a7a-3ab9-4b37-8b58-fc806fd469e0","name":"увеличивать транспортный ёмкость весь тип мембранный переносчик глюкоза","level":4,"r":30,"y":657.5,"x":340},{"label":"excretion","weight":5,"id":"a4f2f6a9-dab1-4b54-b8e1-d655ac5a3ab3","name":"почка","level":4,"r":30,"y":657.5,"x":420},{"label":"mechanism","weight":5,"id":"7d2df5c1-1c2b-4d58-b2e3-58c910578c89","name":"повышать чувствительность периферический рецептор","level":4,"r":30,"y":657.5,"x":500},{"label":"mechanism","weight":5,"id":"ca7df1f1-a992-49c8-9ac1-92fac10f6224","name":"повышать утилизация глюкоза клетка","level":4,"r":30,"y":657.5,"x":580},{"label":"mechanism","weight":5,"id":"e19f8d62-c5a4-4273-b8fa-eec5fabcae9b","name":"ингибирование глюконеогенез","level":4,"r":30,"y":657.5,"x":660},{"label":"mechanism","weight":5,"id":"c1604392-ec6c-4c42-8542-2e2f7f09a57c","name":"ингибирование гликогенолиз","level":4,"r":30,"y":657.5,"x":740},{"label":"mechanism","weight":5,"id":"b83ce070-c170-4988-a0d6-f89c95fc2cc1","name":"снижать концентрация общий холестерин","level":4,"r":30,"y":657.5,"x":820},{"label":"mechanism","weight":5,"id":"7f456c8d-5e68-4523-b79a-7765ecd2f44f","name":"снижать концентрация липопротеин низкий плотность","level":4,"r":30,"y":657.5,"x":900},{"label":"mechanism","weight":5,"id":"41a4a7dd-d1dc-42ec-8100-1345428afcc5","name":"снижать концентрация триглицерид","level":4,"r":30,"y":657.5,"x":980},{"label":"action","weight":5,"id":"0b2092f7-f8c1-4a8f-8d7d-760c1ef31532","name":"снижать базальный концентрация глюкоза в плазма кровь","level":7,"r":30,"y":1047.5,"x":600},{"label":"action","weight":5,"id":"622a27c6-214c-4456-89e9-301da3432c59","name":"снижать постпрандиальный концентрация глюкоза в плазма кровь","level":7,"r":30,"y":1047.5,"x":680}],"links":[{"source":"dbbd5ffa-8bff-4e56-a7b5-48b31105d4ee","target":"0eef3e2b-6580-4fde-b99e-8e4e12bb274a","id":"ae500ecd-9033-457e-b2a9-58af8ab7b0c5"},{"source":"0eef3e2b-6580-4fde-b99e-8e4e12bb274a","target":"f4d0dc59-40ee-4db6-9c91-868e6124b4a9","id":"78dcc838-6d70-49d6-b5f5-c24a9231afde"},{"source":"ef30a80e-95fa-4835-8a35-1552522d4b53","target":"e7d0da1b-7e73-4cfd-ad8c-63486bafc6fb","id":"1ebbfbfc-6c50-4900-b2fb-7a42bdb03691"},{"source":"f4d0dc59-40ee-4db6-9c91-868e6124b4a9","target":"6d71331a-9beb-430c-976a-fb74cde18aab","id":"9380b564-ec33-45a1-91fc-102c300036a4"},{"source":"6d71331a-9beb-430c-976a-fb74cde18aab","target":"1492c96e-bd01-426e-960f-dcaa97778841","id":"6785cb63-3ed6-46e2-8a7a-8b94ac8135f9"},{"source":"6d71331a-9beb-430c-976a-fb74cde18aab","target":"1510a291-6129-4d6e-9350-e134952a190e","id":"721085bd-b943-4f75-8d8f-044b2ae468c5"},{"source":"6d71331a-9beb-430c-976a-fb74cde18aab","target":"26480a7a-3ab9-4b37-8b58-fc806fd469e0","id":"4d632770-7d33-4beb-9085-f9d2c43a1007"},{"source":"6d71331a-9beb-430c-976a-fb74cde18aab","target":"322e6d7d-a512-445e-9920-55be9c207d48","id":"8406b439-9a80-48eb-a06e-942e67a0ecd4"},{"source":"6d71331a-9beb-430c-976a-fb74cde18aab","target":"a4f2f6a9-dab1-4b54-b8e1-d655ac5a3ab3","id":"37ad8017-b98b-4be1-b54d-8ab19d1d72d3"},{"source":"6d71331a-9beb-430c-976a-fb74cde18aab","target":"7d2df5c1-1c2b-4d58-b2e3-58c910578c89","id":"90386857-ec0b-45ac-b217-990facb876ae"},{"source":"6d71331a-9beb-430c-976a-fb74cde18aab","target":"ca7df1f1-a992-49c8-9ac1-92fac10f6224","id":"9c8570f0-5db9-4f46-b20d-01c577b8a0ec"},{"source":"6d71331a-9beb-430c-976a-fb74cde18aab","target":"e19f8d62-c5a4-4273-b8fa-eec5fabcae9b","id":"4b0f25ad-54f3-4d8d-bfb1-7bef4bc7dae2"},{"source":"6d71331a-9beb-430c-976a-fb74cde18aab","target":"c1604392-ec6c-4c42-8542-2e2f7f09a57c","id":"a944a878-cbee-4b17-989f-51d83b48b6a4"},{"source":"6d71331a-9beb-430c-976a-fb74cde18aab","target":"b83ce070-c170-4988-a0d6-f89c95fc2cc1","id":"d37daf1f-ee53-4f3c-98e4-b5fb8a84a7a6"},{"source":"6d71331a-9beb-430c-976a-fb74cde18aab","target":"7f456c8d-5e68-4523-b79a-7765ecd2f44f","id":"cf60fe86-4a73-4e08-b570-3ddef874bf15"},{"source":"6d71331a-9beb-430c-976a-fb74cde18aab","target":"41a4a7dd-d1dc-42ec-8100-1345428afcc5","id":"a0af2645-fbbc-4ed0-92a5-2f99437be8b5"},{"source":"e7d0da1b-7e73-4cfd-ad8c-63486bafc6fb","target":"0b2092f7-f8c1-4a8f-8d7d-760c1ef31532","id":"32fe7b26-95fd-4ecc-88b9-68a8ace09897"},{"source":"e7d0da1b-7e73-4cfd-ad8c-63486bafc6fb","target":"622a27c6-214c-4456-89e9-301da3432c59","id":"88289e08-a188-41ca-8208-314c9cb6cf9c"},{"source":"de3ec42d-b3b6-492a-905c-3bde0e9786f5","target":"e7d0da1b-7e73-4cfd-ad8c-63486bafc6fb","id":"777c94d8-37a5-425f-a6f8-e9411821d53a"},{"source":"1492c96e-bd01-426e-960f-dcaa97778841","target":"e7d0da1b-7e73-4cfd-ad8c-63486bafc6fb","id":"64b2390f-8446-48fd-962a-27d1ed3fd2b4"},{"source":"9f5a0dd1-c73c-4a63-b6e1-a6f50c541e90","target":"e7d0da1b-7e73-4cfd-ad8c-63486bafc6fb","id":"d731db35-a94a-4caa-8ced-1ce48f444064"},{"source":"1510a291-6129-4d6e-9350-e134952a190e","target":"9f5a0dd1-c73c-4a63-b6e1-a6f50c541e90","id":"a549a919-9e6c-4bc7-b44a-770708ff665b"},{"source":"26480a7a-3ab9-4b37-8b58-fc806fd469e0","target":"e7d0da1b-7e73-4cfd-ad8c-63486bafc6fb","id":"a20afac4-e3f2-4b56-9548-326bc5d6e7c0"},{"source":"7d2df5c1-1c2b-4d58-b2e3-58c910578c89","target":"ef30a80e-95fa-4835-8a35-1552522d4b53","id":"3208eaaf-fe2a-405b-8efd-805ba033c46c"},{"source":"ca7df1f1-a992-49c8-9ac1-92fac10f6224","target":"e7d0da1b-7e73-4cfd-ad8c-63486bafc6fb","id":"31fc1d04-cd60-4078-8ff8-0d57770f82f8"},{"source":"e19f8d62-c5a4-4273-b8fa-eec5fabcae9b","target":"de3ec42d-b3b6-492a-905c-3bde0e9786f5","id":"0d75621e-8e1c-447b-8f9b-4b41274a50c1"},{"source":"c1604392-ec6c-4c42-8542-2e2f7f09a57c","target":"de3ec42d-b3b6-492a-905c-3bde0e9786f5","id":"98e5df97-c98e-48b3-b5c3-23ac757f1e27"}],"name":"метформин","maxLevel":8,"levelsInfo":{"levelNodesCount":{"0":15,"1":1,"2":1,"3":1,"4":12,"5":3,"6":1,"7":2}},"isParse":true}
            const window_params = {"width":1200,"height":600,"xStep":50,"yStep":100}

            console.log(graphData)

            

            if (graphData){
                const svg = d3.select("svg")
                svg.selectAll("*").remove() // Очистка предыдущего графа

                svg.attr("width",   window_params.width) //Устанавливает атрибут width
                .attr("height",   window_params.height)
                .append("g").attr('class', 'group') //добавляет новый элемент, тег которого передается в метод в качестве параметра

                const svgGroup = svg.select('g.group')

                // Масштабирование и перемещение
                const zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on("zoom", (event)=>{ //Обновление позиционирования элементов при масштабировании
                    svgGroup.attr("transform", event.transform);
                });
                svg.call(zoom);


                const dragstarted = (event, d)=>{
                    if (!event.active) simulation.alphaTarget(0.3).restart(); // Увеличиваем "температуру" симуляции для более плавного движения
                    d.fx = d.x; // Фиксируем позицию узла
                    d.fy = d.y;
                }
                
                const dragged = (event, d)=>{
                    d.fx = event.x; // Обновляем фиксированные координаты узла
                    d.fy = event.y;
                }
                
                const dragended = (event, d)=>{
                    if (!event.active) simulation.alphaTarget(0); // Охлаждаем симуляцию после перетаскивания
                    d.fx = null; // Отпускаем узел, позволяя симуляции снова влиять на его позицию
                    d.fy = null;
                }

                // Создаем обработчик drag
                const drag = d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);


                // Определение маркера стрелки
                svgGroup.append("defs")
                .append("marker")
                .attr("id", "arrowhead")
                .attr("markerWidth", 5) //Размер области, в которой будет отображаться маркер
                .attr("markerHeight", 4)
                .attr("refX", nodeView.r+4)
                .attr("refY", 2)
                .attr("orient", "auto")
                .append("polygon")
                .attr("points", "0 0, 5 2, 0 4")
                .style("fill", colors.link);

                
                //Добавление ссылок
                let links = svgGroup.append("g").attr('class', 'links')
                .selectAll('.link')
                .data(graphData.links) //Добавление данных
                .enter() //Нужен для ввода дополнительных значений (так как data привязывает только первое)
                .append('path')
                .attr('class', 'link')
                .attr('stroke', d=>{
                    //if((d.source.id === selectedNodes.sourseNode && d.target.id === selectedNodes.targetNode)||(d.target.id === selectedNodes.sourseNode && d.source.id === selectedNodes.targetNode)) return colors.selectLink
                    return colors.link
                }) // Цвет линии ребра
                .attr('stroke-width', d=>{
                    //if((d.source.id === selectedNodes.sourseNode && d.target.id === selectedNodes.targetNode)||(d.target.id === selectedNodes.sourseNode && d.source.id === selectedNodes.targetNode)) return 2
                    return 1
                }) // Ширина линии ребра
                .attr("marker-end", "url(#arrowhead)") // Добавление стрелки в конец ребра
                .style('pointer-events', 'none') //(устанавливает стиль) Отключение событий на ребрах (клики и т.д.)

                // Создание узлов
                let nodes = svgGroup.append("g").attr('class', 'nodes')
                .selectAll('.node')
                .data(graphData.nodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .call(drag);

                nodes.append('circle')
                .attr('class', 'node')
                .attr('id', d => d.id)
                .attr('r', d => d.r) // Радиус узла
                .attr('fill', d=>{
                    //if(selectedNodes.sourseNode === d.id || selectedNodes.targetNode === d.id) return colors.selectNode
                    return colors.node
                }) // Цвет заполнения
                .attr("cursor", "pointer")
                .on('click', (event, d) => {
                    // Добавьте логику для обработки клика по узлу
                });

                //Отображение текста v2
                nodes.append('foreignObject')
                .attr('x', d => -d.r * 0.8)
                .attr('y', d => -d.r * 0.8)
                .attr('width', d => d.r * 1.6)
                .attr('height', d => d.r * 1.6)
                .append('xhtml:div')
                .style('display', 'flex')
                .style('justify-content', 'center')
                .style('align-items', 'center')
                .style('width', '100%')
                .style('height', '100%')
                .style('font-size', '5px')
                .style('text-anchor', 'middle')
                .style('word-wrap', 'break-word')
                .style('overflow', 'hidden')
                .style('pointer-events', 'none')
                .text(d => d.name);

                //Создание симуляции силы v3
                const simulation = d3.forceSimulation(graphData.nodes)
                // Связи между узлами
                .force("link", d3.forceLink(graphData.links).id(d => d.id))//.distance(nodeView.r*10)) //!!! Сила в зависимости от количества узлов в уровне!!!!!
                // Отталкивание узлов
                .force("charge", d3.forceManyBody(graphData.nodes).strength(d=>graphData.levelsInfo.levelNodesCount[d.level]*(-100)))//-3000))
                // Центрирование по x
                .force("center", d3.forceCenter( window_params.width / 2,  window_params.height / 2))
                // Выравнивание по уровням
                .force("y", d3.forceY().strength(6)
                    .y(d =>  window_params.height * ((d.level+1) / (graphData.maxLevel-1)))) //!!!!!!!!!!Уровень с большим числом узлов шире, чем с меньшим
                // Отталкивание по x в рамках одного уровня
                .force("x", d3.forceX().strength(0.05)
                    .x( window_params.width / 2))
                // Дополнительная сила для предотвращения наложения узлов
                .force("collision", d3.forceCollide().radius(40));

                // Обновление позиций узлов и связей при каждой итерации симуляции
                //Обновление симуляции
                simulation.on('tick', () => {
                    links.attr("d", d => `M${d.source.x},${d.source.y} L${d.target.x},${d.target.y}`);
                    nodes.attr('transform', d => `translate(${d.x}, ${d.y})`); // Правильная позиция для групп
                });
            }
        </script>
    </body>
</html>